---
- name: Install RabbitMQ Server and Configure Plugins
  hosts: ubuntu-noble
  become: true

  vars:
    erlang_version: "1:27.2.4-1"
    rabbitmq_version: "4.0.6-1"
    rabbitmq_gpg_key_url: "https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA"
    rabbitmq_gpg_keyring_path: "/usr/share/keyrings/com.rabbitmq.team.gpg"
    rabbitmq_password: "{{ vault_rabbitmq_admin_password }}"  # Encrypted in vault
    erlang_packages:
      - erlang-base
      - erlang-asn1
      - erlang-crypto
      - erlang-eldap
      - erlang-ftp
      - erlang-inets
      - erlang-mnesia
      - erlang-os-mon
      - erlang-parsetools
      - erlang-public-key
      - erlang-runtime-tools
      - erlang-snmp
      - erlang-ssl
      - erlang-syntax-tools
      - erlang-tftp
      - erlang-tools
      - erlang-xmerl

  tasks:
    - name: Install required system packages
      ansible.builtin.apt:
        name:
          - curl
          - gnupg
          - apt-transport-https
        state: present
        update_cache: yes

    - name: Download RabbitMQ team GPG key
      ansible.builtin.shell: |
        curl -1sLf "{{ rabbitmq_gpg_key_url }}" | gpg --dearmor | tee {{ rabbitmq_gpg_keyring_path }} > /dev/null
      args:
        creates: "{{ rabbitmq_gpg_keyring_path }}"

    - name: Add RabbitMQ apt repositories
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/rabbitmq.list
        content: |
          ## Modern Erlang/OTP releases
          deb [arch=amd64 signed-by={{ rabbitmq_gpg_keyring_path }}] https://deb1.rabbitmq.com/rabbitmq-erlang/ubuntu/noble noble main
          deb [arch=amd64 signed-by={{ rabbitmq_gpg_keyring_path }}] https://deb2.rabbitmq.com/rabbitmq-erlang/ubuntu/noble noble main

          ## Latest RabbitMQ releases
          deb [arch=amd64 signed-by={{ rabbitmq_gpg_keyring_path }}] https://deb1.rabbitmq.com/rabbitmq-server/ubuntu/noble noble main
          deb [arch=amd64 signed-by={{ rabbitmq_gpg_keyring_path }}] https://deb2.rabbitmq.com/rabbitmq-server/ubuntu/noble noble main
        mode: '0644'
      register: rabbitmq_repo

    - name: Update apt cache if repository changed
      ansible.builtin.apt:
        update_cache: yes
      when: rabbitmq_repo.changed

    - name: Install Erlang packages
      ansible.builtin.apt:
        name:
          - "erlang-base={{ erlang_version }}"
          - "erlang-asn1={{ erlang_version }}"
          - "erlang-crypto={{ erlang_version }}"
          - "erlang-eldap={{ erlang_version }}"
          - "erlang-ftp={{ erlang_version }}"
          - "erlang-inets={{ erlang_version }}"
          - "erlang-mnesia={{ erlang_version }}"
          - "erlang-os-mon={{ erlang_version }}"
          - "erlang-parsetools={{ erlang_version }}"
          - "erlang-public-key={{ erlang_version }}"
          - "erlang-runtime-tools={{ erlang_version }}"
          - "erlang-snmp={{ erlang_version }}"
          - "erlang-ssl={{ erlang_version }}"
          - "erlang-syntax-tools={{ erlang_version }}"
          - "erlang-tftp={{ erlang_version }}"
          - "erlang-tools={{ erlang_version }}"
          - "erlang-xmerl={{ erlang_version }}"
        state: present

    - name: Install RabbitMQ server
      ansible.builtin.apt:
        name: "rabbitmq-server={{ rabbitmq_version }}"
        state: present

    - name: Hold RabbitMQ and Erlang packages to prevent automatic updates
      ansible.builtin.dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop: "{{ ['rabbitmq-server'] + erlang_packages }}"

    - name: Ensure RabbitMQ configuration directory exists
      ansible.builtin.file:
        path: /etc/rabbitmq
        state: directory
        owner: rabbitmq
        group: rabbitmq
        mode: '0755'

    - name: Configure enabled RabbitMQ plugins
      ansible.builtin.copy:
        dest: /etc/rabbitmq/enabled_plugins
        content: |
          [rabbitmq_delayed_message_exchange,
           rabbitmq_management,
           rabbitmq_prometheus,
           rabbitmq_shovel,
           rabbitmq_shovel_management,
           rabbitmq_shovel_prometheus].
        owner: rabbitmq
        group: rabbitmq
        mode: '0644'
      notify: Restart RabbitMQ

    - name: Configure RabbitMQ main settings
      ansible.builtin.copy:
        dest: /etc/rabbitmq/rabbitmq.conf
        content: |
          cluster_partition_handling = pause_minority
        owner: rabbitmq
        group: rabbitmq
        mode: '0644'
      notify: Restart RabbitMQ

    - name: Ensure RabbitMQ service is enabled and started
      ansible.builtin.systemd:
        name: rabbitmq-server
        enabled: yes
        state: started

    - name: Add RabbitMQ admin user
      command: rabbitmqctl add_user admin "{{ rabbitmq_password }}"
      args:
        creates: /var/lib/rabbitmq/.admin_created
      register: add_user_result
      failed_when: add_user_result.rc not in [0,70]
      changed_when: "'Adding user' in add_user_result.stdout"

    - name: Grant all permissions to admin user
      command: rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"

    - name: Set administrator tag for admin user
      command: rabbitmqctl set_user_tags admin administrator

  handlers:
    - name: Restart RabbitMQ
      ansible.builtin.systemd:
        name: rabbitmq-server
        state: restarted
